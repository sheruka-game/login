<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜技能管理後台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background: #f4f7fa; margin: 0; padding: 2rem; }
    .container { max-width: 1080px; margin: auto; background: white; padding: 2rem; border-radius: 1.3rem; box-shadow: 0 2px 16px #0001; }
    h2 { text-align: center; margin-bottom: 1.5rem; }
    .tabs { display: flex; gap: 1.2em; margin-bottom: 1.5em; }
    .tab { cursor: pointer; padding: 0.6em 2em; border-radius: 2em; background: #eef2fa; color: #1d4076; font-weight: 600; }
    .tab.active { background: #1767a0; color: #fff; }
    .search-row { display: flex; gap: 1em; align-items: center; margin-bottom: 1.2em; }
    .search-row input { flex: 1; padding: 0.5em; border-radius: 0.7em; border: 1px solid #ccc; }
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1em; }
    th, td { border-bottom: 1px solid #eef2fa; padding: 0.4em 0.6em; text-align: left; }
    th { background: #f4f7fa; font-size: 1em; cursor: pointer; }
    td.editing { background: #f5faff; }
    td input, td textarea { width: 95%; border: 1px solid #bfc8d8; border-radius: 0.5em; padding: 0.2em 0.5em; }
    .btn-del { background: #f66464; color: #fff; border: none; border-radius: 0.5em; padding: 0.2em 0.7em; cursor: pointer; font-weight: 700;}
    .pagination { text-align: center; margin: 1em 0; }
    .pagination button { margin: 0 0.25em; border: none; background: #d7e4f5; color: #1767a0; padding: 0.3em 0.7em; border-radius: 0.5em; font-weight: 600; cursor: pointer;}
    .pagination button.active { background: #1767a0; color: #fff; }
    .msg { min-height: 1.5em; margin-bottom: 0.8em; }
    @media (max-width: 720px) {
      .container { padding: 0.7em; }
      .tabs { flex-direction: column; gap: 0.4em; }
      th, td { font-size: 0.94em; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <h2>技能管理後台</h2>
    <div class="tabs">
      <div class="tab active" id="tab-skill" onclick="switchTab('skill')">技能效果</div>
      <div class="tab" id="tab-move" onclick="switchTab('move')">移動技能效果</div>
      <div class="tab" id="tab-debuff" onclick="switchTab('debuff')">技能副作用</div>
    </div>
    <div class="search-row">
      <input id="search" type="text" placeholder="搜尋名稱、描述、顯示代碼、邏輯碼…（即時過濾）" oninput="searchTable()">
      <span class="msg" id="msg"></span>
    </div>
    <div class="table-wrap">
      <table id="data-table"></table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>

  <script>
    // ====== Supabase 設定 ======
    const client = window.supabase.createClient(
      'https://wfhwhvodgikpducrhgda.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8'
    );

    // ============ 配置 =============
    const PAGE_SIZE = 10;
    const TABLES = {
      skill: {
        table: "skill_effects",
        display: "技能效果",
        pk: "effect_id",
        fields: [
          { key: "effect_name", name: "名稱", editable: true },
          { key: "description", name: "描述", editable: true },
          { key: "effect_type", name: "職業類型", editable: false },
          { key: "target_faction", name: "對象", editable: false },
          { key: "max_targets", name: "人數", editable: false },
          { key: "score", name: "分數", editable: true },
          { key: "extra_cd", name: "冷卻", editable: true },
          { key: "effect_id_code", name: "顯示代碼", editable: true },
          { key: "effect_code", name: "程式邏輯碼", editable: true }
        ]
      },
      move: {
        table: "movement_skills",
        display: "移動技能效果",
        pk: "move_id",
        fields: [
          { key: "move_name", name: "名稱", editable: true },
          { key: "description", name: "描述", editable: true },
          { key: "target_faction", name: "對象", editable: false },
          { key: "range", name: "施放區域", editable: false },
          { key: "max_targets", name: "人數", editable: false },
          { key: "extra_cd", name: "冷卻", editable: true },
          { key: "effect_id_code", name: "顯示代碼", editable: true },
          { key: "effect_code", name: "程式邏輯碼", editable: true }
        ]
      },
      debuff: {
        table: "skill_debuff",
        display: "技能副作用",
        pk: "debuff_id",
        fields: [
          { key: "debuff_name", name: "名稱", editable: true },
          { key: "description", name: "描述", editable: true },
          { key: "debuff_type", name: "分類", editable: false },
          { key: "offset_score", name: "抵銷分數", editable: true },
          { key: "extra_cd", name: "冷卻", editable: true },
          { key: "applied_to", name: "套用對象", editable: false },
          { key: "effect_id_code", name: "顯示代碼", editable: true },
          { key: "effect_code", name: "程式邏輯碼", editable: true }
        ]
      }
    };

    // ========== 狀態 ==========
    let currentTab = "skill";
    let rawData = [];
    let filteredData = [];
    let currentPage = 1;
    let sortKey = null;
    let sortAsc = true;
    let editingCell = null;

    // ========== Tab 切換 ==========
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.getElementById('tab-' + tab).classList.add('active');
      document.getElementById('search').value = '';
      currentPage = 1;
      loadData();
    }

    // ========== 載入資料 ==========
    async function loadData() {
      setMsg("資料載入中...");
      const table = TABLES[currentTab].table;
      let { data, error } = await client.from(table).select("*").order(TABLES[currentTab].fields[0].key, { ascending: true });
      if (error) {
        setMsg("資料讀取失敗：" + error.message, true); return;
      }
      rawData = data || [];
      filteredData = rawData;
      renderTable();
      setMsg('');
    }

    // ========== 查詢 ==========
    function searchTable() {
      const kw = document.getElementById('search').value.trim().toLowerCase();
      if (!kw) { filteredData = rawData; currentPage = 1; renderTable(); return; }
      filteredData = rawData.filter(row =>
        Object.values(row).join(' ').toLowerCase().includes(kw)
      );
      currentPage = 1;
      renderTable();
    }

    // ========== 排序 ==========
    function sortBy(key) {
      if (sortKey === key) sortAsc = !sortAsc;
      else { sortKey = key; sortAsc = true; }
      filteredData.sort((a, b) => {
        if (a[key] == null) return 1;
        if (b[key] == null) return -1;
        if (typeof a[key] === "number" && typeof b[key] === "number")
          return sortAsc ? a[key] - b[key] : b[key] - a[key];
        return sortAsc ? String(a[key]).localeCompare(b[key]) : String(b[key]).localeCompare(a[key]);
      });
      renderTable();
    }

    // ========== 分頁 ==========
    function renderTable() {
      const fields = TABLES[currentTab].fields;
      const pk = TABLES[currentTab].pk;
      const table = document.getElementById('data-table');
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageRows = filteredData.slice(start, start + PAGE_SIZE);

      // 表頭
      let th = '<tr>' + fields.map(f =>
        `<th onclick="sortBy('${f.key}')">${f.name}${sortKey === f.key ? (sortAsc ? ' ▲' : ' ▼') : ''}</th>`
      ).join('') + '<th>操作</th></tr>';

      // 表身
      let trs = pageRows.map((row, ridx) => {
        return `<tr>` + fields.map(f => {
          const val = row[f.key] ?? "";
          // 編輯狀態判斷
          if (f.editable && editingCell && editingCell.id === row[pk] && editingCell.key === f.key) {
            return `<td class="editing"><input type="text" value="${val}" 
              onblur="endEdit('${row[pk]}','${f.key}',this.value)" 
              onkeydown="if(event.key==='Enter'){endEdit('${row[pk]}','${f.key}',this.value)}"></td>`;
          } else if (f.editable) {
            return `<td onclick="startEdit('${row[pk]}','${f.key}')">${val || '<span style=\'color:#aaa\'>[空]</span>'}</td>`;
          } else {
            return `<td>${val || ''}</td>`;
          }
        }).join('') + 
        `<td>
          <button class="btn-del" onclick="delRow('${row[pk]}')">刪除</button>
        </td></tr>`;
      }).join('');
      table.innerHTML = th + trs;

      // 分頁
      renderPagination();
    }

    function renderPagination() {
      const pageCount = Math.ceil(filteredData.length / PAGE_SIZE) || 1;
      let html = '';
      for (let i = 1; i <= pageCount; i++) {
        html += `<button ${i === currentPage ? 'class="active"' : ''} onclick="gotoPage(${i})">${i}</button>`;
      }
      document.getElementById('pagination').innerHTML = html;
    }
    function gotoPage(p) { currentPage = p; renderTable(); }

    // ========== 編輯 ==========
    function startEdit(id, key) {
      editingCell = { id, key };
      renderTable();
      setTimeout(() => { // 自動 focus
        let el = document.querySelector('td.editing input, td.editing textarea');
        if(el) el.focus();
      }, 80);
    }
    async function endEdit(id, key, value) {
      const fields = TABLES[currentTab].fields;
      const pk = TABLES[currentTab].pk;
      editingCell = null;
      // 找到該筆的完整資料，修改該欄位
      let row = rawData.find(r => String(r[pk]) === String(id));
      if (!row) return renderTable();
      if (row[key] == value) return renderTable();
      // 組成更新物件
      let updateObj = {};
      updateObj[key] = (fields.find(f => f.key === key) && typeof row[key] === "number") ? Number(value) : value;
      let { error } = await client.from(TABLES[currentTab].table).update(updateObj).eq(pk, id);
      if (error) setMsg('⚠️ 修改失敗: ' + error.message, true);
      else setMsg('✔️ 已修改');
      await loadData();
    }

    // ========== 刪除 ==========
    async function delRow(id) {
      if (!confirm('確定要刪除這筆資料喵？刪錯笑你！')) return;
      const pk = TABLES[currentTab].pk;
      let { error } = await client.from(TABLES[currentTab].table).delete().eq(pk, id);
      if (error) setMsg('⚠️ 刪除失敗: ' + error.message, true);
      else setMsg('已刪除！');
      await loadData();
    }

    function setMsg(msg, err) {
      document.getElementById('msg').innerHTML = msg ? `<span style="color:${err ? '#d44':'#1767a0'}">${msg}</span>` : '';
    }

    // ========== 首次載入 ==========
    loadData();

    // 全域可用
    window.switchTab = switchTab;
    window.searchTable = searchTable;
    window.sortBy = sortBy;
    window.gotoPage = gotoPage;
    window.startEdit = startEdit;
    window.endEdit = endEdit;
    window.delRow = delRow;
  </script>
</body>
</html>
